# ğŸš€ GitHub Actions ì›Œí¬í”Œë¡œìš°: í¬í¬ëœ ì €ì¥ì†Œ ìë™ ë™ê¸°í™”
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ì›ë³¸ ì €ì¥ì†Œì˜ dev ë¸Œëœì¹˜ ë³€ê²½ ì‚¬í•­ì„ í¬í¬ëœ ì €ì¥ì†Œë¡œ ìë™ìœ¼ë¡œ ë™ê¸°í™”í•©ë‹ˆë‹¤.

name: synchronization

# âœ… ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´
on:
  push:
    branches:
      - dev # dev ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œë§ˆë‹¤ ìë™ìœ¼ë¡œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰

jobs:
  sync:
    name: Sync forked repo # ì‘ì—…(Job) ì´ë¦„
    runs-on: ubuntu-latest # ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ì‹¤í–‰

    timeout-minutes: 10 # â±ï¸ 1. íƒ€ì„ì•„ì›ƒ ì„¤ì •: 10ë¶„ ë™ì•ˆ ì‹¤í–‰ë˜ì§€ ì•Šìœ¼ë©´ ìë™ ì¢…ë£Œ (ë¬´í•œ ë£¨í”„ ë°©ì§€)

    steps:
      # ğŸ“¥ 2. í˜„ì¬ ì €ì¥ì†Œì˜ dev ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒ
      - name: Checkout dev
        uses: actions/checkout@v4 # GitHubì—ì„œ ì œê³µí•˜ëŠ” ê³µì‹ ì•¡ì…˜
        with:
          token: ${{ secrets.FORKED_REPO_TOKEN }} # í¬í¬ëœ ì €ì¥ì†Œì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ ì¸ì¦ í† í°
          fetch-depth: 0 # ì „ì²´ Git íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (íˆìŠ¤í† ë¦¬ ëˆ„ë½ ë°©ì§€)

      # ğŸŒ 3. í¬í¬ëœ ì €ì¥ì†Œë¥¼ ì›ê²© ì €ì¥ì†Œë¡œ ì¶”ê°€í•˜ê³  Git ì„¤ì •
      - name: Add remote for forked repo
        run: |
          # í¬í¬ëœ ì €ì¥ì†Œë¥¼ "forked-repo"ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì¶”ê°€
          git remote add forked-repo https://${{ secrets.FORKED_REPO_TOKEN }}@github.com/Bear4243/5-ViewMyStartup-team2-FE.git

          # Git ì‚¬ìš©ì ì •ë³´ ì„¤ì • (ì»¤ë°‹ ë©”íƒ€ë°ì´í„°ì— í‘œì‹œë¨)
          git config user.name "Bear4243"
          git config user.email "ujm4243@naver.com"

      # ğŸ” 4. ë³€ê²½ ì‚¬í•­ ë° ë³‘í•© ì¶©ëŒ í™•ì¸
      - name: Fetch forked repo and check for conflicts
        run: |
          # í¬í¬ëœ ì €ì¥ì†Œì˜ dev ë¸Œëœì¹˜ ìµœì‹  ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
          git fetch forked-repo dev

          # âœ… ë³€ê²½ ì‚¬í•­ í™•ì¸: HEADì™€ forked-repo/dev ë¹„êµ
          if git diff --quiet HEAD forked-repo/dev; then
            echo "âœ… No changes to sync. Exiting."  # ë³€ê²½ ì‚¬í•­ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
            exit 0
          fi

          # âš ï¸ ë³‘í•© ì¶©ëŒ ì‚¬ì „ í™•ì¸ (ì‹¤ì œ ë³‘í•© ì—†ì´ ì‹œë®¬ë ˆì´ì…˜)
          if ! git merge --no-commit --no-ff forked-repo/dev; then
            echo "âŒ Merge conflict detected. Aborting sync."  # ì¶©ëŒ ë°œìƒ ì‹œ ë©”ì‹œì§€ ì¶œë ¥
            git merge --abort  # ë³‘í•© ì¤‘ë‹¨ ë° ì´ì „ ìƒíƒœë¡œ ë³µì›
            exit 1  # ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ì²˜ë¦¬
          fi

      # ğŸš€ 5. ë³€ê²½ ì‚¬í•­ ë³‘í•© ë° í‘¸ì‹œ
      - name: Merge and Push changes
        run: |
          set -e  # â— ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ (ì•ˆì „ì„± ê°•í™”)

          # ë³€ê²½ ì‚¬í•­ ë³‘í•© (ì¶©ëŒì´ ì—†ëŠ” ê²½ìš° ìë™ ë³‘í•©)
          git merge forked-repo/dev --no-edit

          # í¬í¬ëœ ì €ì¥ì†Œë¡œ ë³‘í•©ëœ ë‚´ìš© í‘¸ì‹œ
          git push forked-repo dev

          echo "ğŸš€ Sync successful."  # ì„±ê³µ ë©”ì‹œì§€ ì¶œë ¥

      # ğŸ§¹ 6. ì •ë¦¬ ì‘ì—… (ì›ê²© ì €ì¥ì†Œ ì œê±°)
      - name: Clean up
        run: |
          git remote remove forked-repo  # ì‚¬ìš©í•œ ì›ê²© ì €ì¥ì†Œ ì‚­ì œ (ë³´ì•ˆ ë° ê¹”ë”í•œ ìƒíƒœ ìœ ì§€)
